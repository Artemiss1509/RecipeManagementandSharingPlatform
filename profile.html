<!DOCTYPE html>
<html>
<head>
    <title>My Profile</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>My Profile</h1>
    <nav class="navbar">
    <button onclick="window.location.href='recipes.html'">Browse Recipes</button>
    <button onclick="logout()">Logout</button>
    </nav>

    <div class="container">
    <div id="profile-info"></div>

    <div>
        <h3>Update Profile</h3>
        <input type="text" id="username" placeholder="Username">
        <input type="email" id="email" placeholder="Email">
        <textarea id="bio" placeholder="Bio"></textarea>
        <input type="file" id="profilePic"><br>
        <button onclick="updateProfile()">Update Profile</button>
        
    </div>

    <div>
        <h3>Change Password</h3>
        <input type="password" id="currentPassword" placeholder="Current Password">
        <input type="password" id="newPassword" placeholder="New Password">
        <button onclick="changePassword()">Change Password</button>
    </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';

        function getToken() {
            return localStorage.getItem('token');
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        async function loadProfile() {
            try {
                const response = await axios.get(`${API_URL}/profile/me/profile`, {
                    headers: { Authorization: `Bearer ${getToken()}` }
                });
                
                const user = response.data.user;
                const stats = response.data.statistics;
                
                document.getElementById('profile-info').innerHTML = `
                    <h2>${user.username}</h2>
                    <p>Email: ${user.email}</p>
                    <p>Bio: ${user.bio || 'No bio yet'}</p>
                    <p>Recipes: ${stats.recipes} | Followers: ${stats.followers} | Following: ${stats.following}</p>
                `;
                
                document.getElementById('username').value = user.username;
                document.getElementById('email').value = user.email;
                document.getElementById('bio').value = user.bio || '';
            } catch (error) {
                alert('Error: ' + error.response?.data?.message);
            }
        }

        async function updateProfile() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const bio = document.getElementById('bio').value;
            const fileInput = document.getElementById('profilePic');

            try {
                await axios.put(`${API_URL}/profile/me/profile`, 
                    { username, email, bio, profilePic: fileInput.files[0] ? fileInput.files[0].name : undefined },
                    { headers: { Authorization: `Bearer ${getToken()}` } }
                );
                alert('Profile updated!');
                loadProfile();
            } catch (error) {
                alert('Error: ' + error.response?.data?.message);
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;

            try {
                await axios.put(`${API_URL}/profile/change-password`, 
                    { currentPassword, newPassword },
                    { headers: { Authorization: `Bearer ${getToken()}` } }
                );
                alert('Password changed successfully!');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
            } catch (error) {
                alert('Error: ' + error.response?.data?.message);
            }
        }

        loadProfile();
    </script>
</body>
</html>
